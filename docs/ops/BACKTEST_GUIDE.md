# å›æµ‹ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

å›æµ‹ç³»ç»Ÿï¼ˆBacktest Serviceï¼‰ç”¨äºä½¿ç”¨å†å²æ•°æ®éªŒè¯ç­–ç•¥æ•ˆæœï¼Œå¸®åŠ©è¯„ä¼°ç­–ç•¥çš„æ”¶ç›Šã€é£é™©å’Œç¨³å®šæ€§ã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… å†å²æ•°æ®å›æ”¾
- âœ… æ¨¡æ‹Ÿäº¤æ˜“ï¼ˆå¼€ä»“/å¹³ä»“ï¼‰
- âœ… æ­¢æŸæ­¢ç›ˆæ£€æŸ¥
- âœ… åŸºç¡€æŒ‡æ ‡è®¡ç®—ï¼ˆèƒœç‡ã€æ”¶ç›Šã€å›æ’¤ï¼‰
- âœ… æƒç›Šæ›²çº¿è®°å½•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ data-providerï¼ˆæä¾›å†å²æ•°æ®ï¼‰
cd services/data-provider
PYTHONPATH=../.. python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8005 &

# å¯åŠ¨ backtest æœåŠ¡ï¼ˆFlaskï¼‰
cd ../backtest
PYTHONPATH=../.. python3 app/main.py &
```

### 2. è¿è¡Œæ¼”ç¤º

```bash
# å®Œæ•´æ¼”ç¤ºï¼ˆåŒ…å« API è°ƒç”¨ï¼‰
bash scripts/demo_backtest.sh

# ç®€å•æµ‹è¯•ï¼ˆä¸ä¾èµ– HTTP æœåŠ¡ï¼‰
python3 scripts/test_backtest_simple.py
```

---

## ğŸ“Š API æ¥å£

### POST /api/backtest/run

è¿è¡Œå›æµ‹ã€‚

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
    "strategy_code": "ma_cross",           // å¿…å¡«ï¼šç­–ç•¥ä»£ç 
    "strategy_config": {                   // å¯é€‰ï¼šç­–ç•¥å‚æ•°
        "fast_ma": 5,
        "slow_ma": 20
    },
    "symbol": "BTCUSDT",                   // å¿…å¡«ï¼šäº¤æ˜“å¯¹
    "timeframe": "15m",                    // å¿…å¡«ï¼šæ—¶é—´å‘¨æœŸ
    "candles": [...],                      // å¿…å¡«ï¼šå†å²Kçº¿æ•°æ®ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
    "initial_balance": 10000.0,            // å¯é€‰ï¼šåˆå§‹èµ„é‡‘ï¼ˆé»˜è®¤ 10000ï¼‰
    "commission_rate": 0.001,              // å¯é€‰ï¼šæ‰‹ç»­è´¹ç‡ï¼ˆé»˜è®¤ 0.1%ï¼‰
    "lookback": 50                         // å¯é€‰ï¼šç­–ç•¥éœ€è¦çš„å†å²æ•°æ®é•¿åº¦ï¼ˆé»˜è®¤ 50ï¼‰
}
```

**Kçº¿æ•°æ®æ ¼å¼ï¼š**

```json
[
    {
        "timestamp": "2026-01-31T15:00:00",
        "open": 50000.0,
        "high": 50100.0,
        "low": 49900.0,
        "close": 50050.0,
        "volume": 100.5
    },
    ...
]
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
    "success": true,
    "result": {
        "strategy_code": "ma_cross",
        "symbol": "BTCUSDT",
        "timeframe": "15m",
        "start_time": "2026-01-31T20:00:00",
        "end_time": "2026-02-05T12:15:00",
        
        // äº¤æ˜“ç»Ÿè®¡
        "total_trades": 29,
        "winning_trades": 9,
        "losing_trades": 20,
        "win_rate": 31.03,
        
        // æ”¶ç›Šç»Ÿè®¡
        "total_pnl": -1293.25,
        "total_pnl_pct": -12.93,
        "avg_pnl": -44.59,
        "avg_win": 823.45,
        "avg_loss": -435.22,
        
        // é£é™©ç»Ÿè®¡
        "max_drawdown": 6390.71,
        "max_drawdown_pct": 63.0,
        
        // è´¦æˆ·ç»Ÿè®¡
        "initial_balance": 10000.0,
        "final_balance": 8513.93,
        "peak_balance": 10143.34,
        
        // äº¤æ˜“è®°å½•
        "trades": [
            {
                "trade_id": 1,
                "side": "SELL",
                "entry_price": 42550.99,
                "entry_time": "2026-01-31T20:00:00",
                "exit_price": 43046.88,
                "exit_time": "2026-02-01T02:15:00",
                "exit_reason": "SIGNAL",
                "pnl": -495.88,
                "pnl_pct": -1.17
            },
            ...
        ],
        
        // æƒç›Šæ›²çº¿ï¼ˆå¯é€‰ï¼‰
        "equity_curve": [...]
    }
}
```

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå‘½ä»¤è¡Œæµ‹è¯•

```bash
# è·å–å†å²æ•°æ®
curl -s "http://127.0.0.1:8005/api/candles?symbol=BTCUSDT&timeframe=15m&limit=500" \
    > /tmp/candles.json

# è¿è¡Œå›æµ‹
curl -X POST http://127.0.0.1:8030/api/backtest/run \
    -H "Content-Type: application/json" \
    -d '{
        "strategy_code": "ma_cross",
        "symbol": "BTCUSDT",
        "timeframe": "15m",
        "candles": '$(cat /tmp/candles.json | jq '.candles')',
        "initial_balance": 10000
    }' | jq '.'
```

### ç¤ºä¾‹ 2ï¼šPython ä»£ç 

```python
import requests

# è·å–å†å²æ•°æ®
candles_resp = requests.get(
    "http://127.0.0.1:8005/api/candles",
    params={"symbol": "BTCUSDT", "timeframe": "15m", "limit": 500}
)
candles = candles_resp.json()["candles"]

# è½¬æ¢æ—¶é—´æˆ³æ ¼å¼
candles_formatted = [
    {
        "timestamp": datetime.fromtimestamp(c["timestamp"]).isoformat(),
        "open": c["open"],
        "high": c["high"],
        "low": c["low"],
        "close": c["close"],
        "volume": c["volume"],
    }
    for c in candles
]

# è¿è¡Œå›æµ‹
backtest_resp = requests.post(
    "http://127.0.0.1:8030/api/backtest/run",
    json={
        "strategy_code": "ma_cross",
        "strategy_config": {"fast_ma": 5, "slow_ma": 20},
        "symbol": "BTCUSDT",
        "timeframe": "15m",
        "candles": candles_formatted,
        "initial_balance": 10000,
    }
)

result = backtest_resp.json()["result"]
print(f"æ€»äº¤æ˜“: {result['total_trades']}")
print(f"èƒœç‡: {result['win_rate']:.2f}%")
print(f"æ”¶ç›Šç‡: {result['total_pnl_pct']:.2f}%")
print(f"æœ€å¤§å›æ’¤: {result['max_drawdown_pct']:.2f}%")
```

---

## ğŸ“ˆ å›æµ‹æŒ‡æ ‡è¯´æ˜

### äº¤æ˜“ç»Ÿè®¡
- **total_trades**: æ€»äº¤æ˜“æ¬¡æ•°
- **winning_trades**: ç›ˆåˆ©äº¤æ˜“æ¬¡æ•°
- **losing_trades**: äºæŸäº¤æ˜“æ¬¡æ•°
- **win_rate**: èƒœç‡ï¼ˆ%ï¼‰

### æ”¶ç›Šç»Ÿè®¡
- **total_pnl**: æ€»ç›ˆäºï¼ˆUSDTï¼‰
- **total_pnl_pct**: æ€»æ”¶ç›Šç‡ï¼ˆ%ï¼‰
- **avg_pnl**: å¹³å‡æ¯ç¬”ç›ˆäº
- **avg_win**: å¹³å‡ç›ˆåˆ©
- **avg_loss**: å¹³å‡äºæŸ

### é£é™©ç»Ÿè®¡
- **max_drawdown**: æœ€å¤§å›æ’¤ï¼ˆUSDTï¼‰
- **max_drawdown_pct**: æœ€å¤§å›æ’¤ç‡ï¼ˆ%ï¼‰

### è´¦æˆ·ç»Ÿè®¡
- **initial_balance**: åˆå§‹èµ„é‡‘
- **final_balance**: æœ€ç»ˆèµ„é‡‘
- **peak_balance**: æœ€é«˜èµ„é‡‘

---

## âš™ï¸ å›æµ‹å¼•æ“å·¥ä½œåŸç†

### 1. å†å²æ•°æ®å›æ”¾

å›æµ‹å¼•æ“é€æ ¹ K çº¿å›æ”¾å†å²æ•°æ®ï¼Œæ¨¡æ‹ŸçœŸå®äº¤æ˜“ç¯å¢ƒï¼š

```
Kçº¿ 1 â†’ Kçº¿ 2 â†’ Kçº¿ 3 â†’ ... â†’ Kçº¿ N
  â†“       â†“       â†“              â†“
åˆ†æ    åˆ†æ    åˆ†æ           åˆ†æ
  â†“       â†“       â†“              â†“
ä¿¡å·    ä¿¡å·    ä¿¡å·           ä¿¡å·
  â†“       â†“       â†“              â†“
äº¤æ˜“    äº¤æ˜“    äº¤æ˜“           äº¤æ˜“
```

### 2. æ¨¡æ‹Ÿäº¤æ˜“

- **å¼€ä»“**ï¼šæ ¹æ®ç­–ç•¥ä¿¡å·å¼€ä»“ï¼Œæ‰£é™¤æ‰‹ç»­è´¹
- **æŒä»“**ï¼šè®°å½•æŒä»“çŠ¶æ€ï¼Œè®¡ç®—æµ®åŠ¨ç›ˆäº
- **å¹³ä»“**ï¼šæ ¹æ®ä»¥ä¸‹æ¡ä»¶å¹³ä»“ï¼š
  - æ­¢æŸè§¦å‘
  - æ­¢ç›ˆè§¦å‘
  - åå‘ä¿¡å·
  - å›æµ‹ç»“æŸ

### 3. æ­¢æŸæ­¢ç›ˆæ£€æŸ¥

æ¯æ ¹ K çº¿æ£€æŸ¥å½“å‰æŒä»“æ˜¯å¦è§¦å‘æ­¢æŸ/æ­¢ç›ˆï¼š

- **åšå¤šï¼ˆBUYï¼‰**ï¼š
  - æ­¢æŸï¼š`low <= stop_loss` â†’ å¹³ä»“
  - æ­¢ç›ˆï¼š`high >= take_profit` â†’ å¹³ä»“

- **åšç©ºï¼ˆSELLï¼‰**ï¼š
  - æ­¢æŸï¼š`high >= stop_loss` â†’ å¹³ä»“
  - æ­¢ç›ˆï¼š`low <= take_profit` â†’ å¹³ä»“

### 4. ç›ˆäºè®¡ç®—

```
ç›ˆäº = (å¹³ä»“ä»· - å¼€ä»“ä»·) Ã— ä»“ä½æ•°é‡ - æ‰‹ç»­è´¹
ç›ˆäºç‡ = (ç›ˆäº / å¼€ä»“ä»·) Ã— 100%
```

---

## ğŸ¯ æ”¯æŒçš„ç­–ç•¥

å½“å‰æ”¯æŒä»¥ä¸‹ç­–ç•¥ï¼ˆå¯é€šè¿‡ `strategy_code` æŒ‡å®šï¼‰ï¼š

### åŸºç¡€ç­–ç•¥
- `ma_cross` - å‡çº¿é‡‘å‰ç­–ç•¥
- `macd` - MACD ç­–ç•¥
- `rsi_boll` - RSI + å¸ƒæ—å¸¦ç­–ç•¥
- `boll_squeeze` - å¸ƒæ—å¸¦æŒ¤å‹ç­–ç•¥
- `breakout` - çªç ´ç­–ç•¥
- `momentum` - åŠ¨é‡ç­–ç•¥

### è¶‹åŠ¿ç­–ç•¥
- `trend_aggressive` - æ¿€è¿›è¶‹åŠ¿ç­–ç•¥
- `trend_add` - è¶‹åŠ¿åŠ ä»“ç­–ç•¥
- `swing` - æ‘†åŠ¨äº¤æ˜“ç­–ç•¥
- `ma_dense` - å¤šå‡çº¿ç­–ç•¥

### éœ‡è¡/åè½¬ç­–ç•¥
- `reversal` - åè½¬ç­–ç•¥
- `scalping` - å‰¥å¤´çš®ç­–ç•¥
- `arbitrage` - å¥—åˆ©ç­–ç•¥

### å¯¹å†²ç­–ç•¥
- `hedge` - å¯¹å†²ç­–ç•¥
- `hedge_conservative` - ä¿å®ˆå¯¹å†²ç­–ç•¥
- `reversal_hedge` - åè½¬å¯¹å†²ç­–ç•¥

### é«˜çº§ç­–ç•¥
- `smc` - Smart Money Concept
- `mtf` - å¤šæ—¶é—´å‘¨æœŸç­–ç•¥
- `sr_break` - æ”¯æ’‘é˜»åŠ›çªç ´
- `grid` - ç½‘æ ¼ç­–ç•¥
- `hft` - é«˜é¢‘äº¤æ˜“ç­–ç•¥

**æŸ¥çœ‹æ‰€æœ‰ç­–ç•¥ï¼š**

```bash
curl http://127.0.0.1:8020/api/strategies
```

---

## ğŸ” æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è¦æ±‚

- K çº¿æ•°æ®å¿…é¡»æŒ‰æ—¶é—´**å‡åº**æ’åˆ—
- è‡³å°‘éœ€è¦ `lookback + 1` æ ¹ K çº¿ï¼ˆé»˜è®¤ 51 æ ¹ï¼‰
- æ—¶é—´æˆ³æ ¼å¼ï¼šISO 8601ï¼ˆä¾‹å¦‚ `2026-01-31T15:00:00`ï¼‰

### 2. æ‰‹ç»­è´¹

- é»˜è®¤æ‰‹ç»­è´¹ç‡ï¼š0.1%ï¼ˆ`commission_rate: 0.001`ï¼‰
- å¼€ä»“å’Œå¹³ä»“éƒ½ä¼šæ‰£é™¤æ‰‹ç»­è´¹
- æ‰‹ç»­è´¹ä»ç›ˆäºä¸­æ‰£é™¤

### 3. ä»“ä½ç®¡ç†

- v0 ç‰ˆæœ¬ï¼šå›ºå®šä»“ä½ 1.0ï¼ˆæ¯æ¬¡äº¤æ˜“å›ºå®šæ•°é‡ï¼‰
- åç»­ç‰ˆæœ¬ï¼šæ”¯æŒåŠ¨æ€ä»“ä½è®¡ç®—

### 4. å›æµ‹é™åˆ¶

- v0 ç‰ˆæœ¬ä»…æ”¯æŒå•ä¸€æŒä»“ï¼ˆä¸æ”¯æŒåŒæ—¶å¤šä¸ªæŒä»“ï¼‰
- ä¸æ”¯æŒåŠ ä»“/å‡ä»“ï¼ˆåªæ”¯æŒå…¨ä»“å¼€å¹³ï¼‰
- æ¨¡æ‹Ÿæˆäº¤ä»·æ ¼ä½¿ç”¨ K çº¿çš„ close ä»·æ ¼

---

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ”¯æŒåŠ¨æ€ä»“ä½è®¡ç®—ï¼ˆæŒ‰é£é™©æ¯”ä¾‹ï¼‰
- [ ] æ”¯æŒå¤šå“ç§å›æµ‹
- [ ] æ”¯æŒå‚æ•°ä¼˜åŒ–
- [ ] ç”Ÿæˆè¯¦ç»†å›æµ‹æŠ¥å‘Šï¼ˆPDF/HTMLï¼‰
- [ ] æ”¯æŒæ›´å¤šæŒ‡æ ‡ï¼ˆå¤æ™®æ¯”ç‡ã€å¡ç›æ¯”ç‡ç­‰ï¼‰
- [ ] æ”¯æŒçœŸå®æˆäº¤ä»·æ ¼æ¨¡æ‹Ÿï¼ˆæ»‘ç‚¹ï¼‰

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: å›æµ‹ç»“æœæ˜¯äºæŸçš„ï¼Œç­–ç•¥æœ‰é—®é¢˜å—ï¼Ÿ

A: ä¸ä¸€å®šã€‚å¯èƒ½çš„åŸå› ï¼š
1. ç­–ç•¥å‚æ•°éœ€è¦ä¼˜åŒ–
2. å¸‚åœºç¯å¢ƒä¸é€‚åˆè¯¥ç­–ç•¥ï¼ˆå¦‚éœ‡è¡å¸‚ç”¨è¶‹åŠ¿ç­–ç•¥ï¼‰
3. æ‰‹ç»­è´¹å’Œæ»‘ç‚¹å½±å“è¾ƒå¤§
4. æ ·æœ¬æ•°æ®ä¸è¶³

å»ºè®®ï¼šå°è¯•ä¸åŒå‚æ•°ã€ä¸åŒæ—¶é—´æ®µã€ä¸åŒå“ç§è¿›è¡Œå›æµ‹ã€‚

### Q: å¦‚ä½•è·å–çœŸå®å†å²æ•°æ®ï¼Ÿ

A: v0 ç‰ˆæœ¬ä½¿ç”¨ mock æ•°æ®ã€‚åç»­å¯ä»¥ï¼š
1. ä»äº¤æ˜“æ‰€ API ä¸‹è½½ï¼ˆBinanceã€OKX ç­‰ï¼‰
2. ä½¿ç”¨ç¬¬ä¸‰æ–¹æ•°æ®æœåŠ¡ï¼ˆTradingViewã€CryptoCompare ç­‰ï¼‰
3. æœ¬åœ°å­˜å‚¨å†å²æ•°æ®åˆ°æ•°æ®åº“

### Q: å›æµ‹ç»“æœèƒ½ç›´æ¥ç”¨äºå®ç›˜å—ï¼Ÿ

A: **ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼** å›æµ‹åªæ˜¯å†å²éªŒè¯ï¼Œå®ç›˜è¿˜éœ€è¦è€ƒè™‘ï¼š
1. æ»‘ç‚¹å’Œæˆäº¤å»¶è¿Ÿ
2. å¸‚åœºæ·±åº¦å’ŒæµåŠ¨æ€§
3. æç«¯è¡Œæƒ…ä¸‹çš„é£é™©
4. å¿ƒç†å› ç´ å’Œæ‰§è¡Œçºªå¾‹

å»ºè®®ï¼šå…ˆå°èµ„é‡‘å®ç›˜éªŒè¯ï¼Œç¡®è®¤ç¨³å®šåå†æ”¾å¤§èµ„é‡‘ã€‚

---

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹ backtest æœåŠ¡æ—¥å¿—
tail -f logs/backtest.log

# æŸ¥çœ‹ data-provider æ—¥å¿—
tail -f logs/data-provider.log
```

æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
