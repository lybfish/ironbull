# 量化能力模型（Capabilities）

本文档为规划阶段产出，遵循 `docs/PLANNING_ONLY.md` 的全局约束：仅输出能力边界、不变量与失败模式，不涉及任何代码、表结构或接口实现。

---

## 概述

量化平台的核心能力被拆分为 **9 个能力域**，每个能力域有明确的职责边界、正确性规则（不变量）与常见失败模式。这 9 个能力域的划分既满足量化业务闭环，也便于对旧项目进行能力映射与差异分析。

| 序号 | 能力域 | 英文名 | 一句话定位 |
|------|--------|--------|------------|
| 1 | 策略 | Strategy | 策略定义、版本、参数与生命周期管理 |
| 2 | 行情/数据源 | MarketData | 标的、K线、Tick、基本面等数据的接入与分发 |
| 3 | 信号 | Signal | 因子计算、选股逻辑、买卖信号的产出 |
| 4 | 回测 | Backtest | 基于历史数据的策略模拟执行与结果产出 |
| 5 | 执行 | Execution | 将交易指令转化为交易所/经纪商订单的通道 |
| 6 | 订单/成交 | OrderTrade | 订单生命周期与成交流水的事实记录 |
| 7 | 持仓 | Position | 标的级别的持仓数量与成本管理 |
| 8 | 账本 | Ledger | 资金、权益、费用、账务的记账与对账 |
| 9 | 分析 | Analytics | 绩效、风险、归因指标与报表 |

---

## 1. Strategy（策略）

### A. 职责（做什么）

- 策略的创建、命名、描述与归档
- 策略版本管理（草稿、已发布、已归档、已废弃）
- 策略参数模板与实例化参数的管理
- 策略与标的池、因子集、风控规则的关联配置
- 策略的启用/停用/克隆/导出生命周期操作

### B. 边界（不做什么）

- **不负责** 策略的执行引擎实现（由 Backtest 或 Execution 承载）
- **不负责** 因子/信号的计算逻辑（由 Signal 承载）
- **不负责** 订单的实际下发与成交（由 Execution、OrderTrade 承载）
- **不负责** 策略收益的计算与归因（由 Analytics 承载）
- **不负责** 行情数据的获取与存储（由 MarketData 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **版本不可篡改**：已发布版本的策略定义（逻辑描述、参数模板）一旦发布即不可修改，只能新建版本。
2. **版本可追溯**：任意一次回测或实盘执行必须能精确关联到某一策略版本。
3. **参数完整性**：策略实例化时，所有必填参数必须有值；参数值必须在模板定义的合法范围内。
4. **生命周期单向**：策略状态流转只能按规定路径（草稿→发布→归档/废弃），不允许反向或跳跃。
5. **租户隔离**：策略归属某一租户，跨租户不可见、不可引用、不可克隆。
6. **删除软化**：策略不得物理删除，只能标记废弃；已被回测或实盘引用的策略版本永久保留。

### D. 常见失败模式

1. **版本覆盖**：修改已发布策略却未新建版本，导致历史回测/实盘记录与策略定义不一致，无法复现。
2. **参数漂移**：运行时参数与策略版本记录的参数不一致，导致收益归因失真。
3. **孤儿策略**：策略被删除或租户迁移后，历史回测/实盘记录失去关联策略上下文。
4. **状态跳跃**：绕过状态机直接修改策略状态，导致未完成审核的策略进入生产。
5. **跨租户泄漏**：权限校验缺失导致租户 A 能查看或克隆租户 B 的策略。

---

## 2. MarketData（行情/数据源）

### A. 职责（做什么）

- 标的主数据（股票、期货、期权、数字货币等）的接入与维护
- K 线（分钟/日/周/月）、Tick、Level2 等时序行情的采集与存储
- 基本面数据（财务、分红、公告）的接入
- 数据源的注册、健康监控与切换
- 历史数据补全与数据质量校验
- 向下游（Signal、Backtest、Analytics）提供统一的数据查询能力

### B. 边界（不做什么）

- **不负责** 因子计算或信号产出（由 Signal 承载）
- **不负责** 策略逻辑或回测编排（由 Strategy、Backtest 承载）
- **不负责** 订单下发或成交记录（由 Execution、OrderTrade 承载）
- **不负责** 数据的商业授权与版权合规（由运营/法务流程处理）
- **不负责** 实时推送到交易终端 UI（由 Apps 层承载）

### C. 不变量（必须永远成立的正确性规则）

1. **时间戳标准化**：所有时序数据必须统一到约定时区与精度（如 UTC 毫秒），存储时不丢失原始时间戳。
2. **标的唯一标识**：同一标的在整个平台内有且只有一个规范化 ID，不因数据源不同而重复。
3. **数据不可回溯篡改**：历史 K 线/Tick 一旦落库，不可被后续数据覆盖（除非显式走数据修正流程并留痕）。
4. **数据连续性可检测**：必须能检测并标记缺失的时间片段（如某日 K 线缺失），下游可据此决定是否使用。
5. **来源可追溯**：每条数据必须记录数据源标识与采集时间，便于质量问题溯源。
6. **租户隔离（若需）**：若不同租户有专属数据源或数据权限，则数据访问必须在租户边界内。

### D. 常见失败模式

1. **时区混乱**：不同数据源使用不同时区，合并后时间戳错位，导致因子/回测计算错误。
2. **重复入库**：同一时间片数据多次写入，导致 K 线成交量翻倍或 Tick 重复。
3. **标的 ID 冲突**：不同交易所相同代码（如 "600000"）未加市场前缀，导致数据串标的。
4. **数据断档**：节假日、停牌、熔断期间未正确标记，下游误以为数据缺失或错用零值。
5. **延迟未感知**：实时行情延迟超阈值未告警，导致实盘策略使用过期行情下单。

---

## 3. Signal（信号/选股/因子输出）

### A. 职责（做什么）

- 因子的定义、版本与参数管理
- 基于 MarketData 计算因子值（动量、波动率、财务比率等）
- 选股/过滤逻辑的编排（如"市值 > 100 亿 且 PE < 20"）
- 产出买卖信号（标的、方向、强度/权重）
- 因子/信号的历史快照存储，供回测与归因使用

### B. 边界（不做什么）

- **不负责** 原始行情数据的采集与存储（由 MarketData 承载）
- **不负责** 策略的完整定义与生命周期（由 Strategy 承载）
- **不负责** 信号到订单的转化与下发（由 Execution 承载）
- **不负责** 回测的时间推进与撮合模拟（由 Backtest 承载）
- **不负责** 收益归因与绩效报表（由 Analytics 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **因子可复现**：给定相同输入数据与参数，因子计算结果必须完全一致（确定性）。
2. **无未来信息**：因子计算只能使用截至计算时点（含）之前的数据，严禁使用未来数据。
3. **信号时间戳准确**：信号产出时间必须等于或晚于所依赖数据的最新时间戳，不可早于。
4. **版本绑定**：每个信号输出必须关联因子版本与参数快照，便于事后审计。
5. **空值显式化**：因子计算遇到数据缺失时，必须显式输出空值/标记，不得用默认值（如 0）静默替代。

### D. 常见失败模式

1. **未来函数**：误用未来数据（如用当日收盘价计算当日开盘信号），导致回测虚高、实盘失效。
2. **幸存者偏差**：选股时使用当前存续标的列表回测历史，忽略已退市标的，导致收益高估。
3. **因子漂移**：因子定义变更后未新建版本，导致同一因子 ID 在不同时期含义不同。
4. **空值传播**：上游数据缺失未处理，导致下游因子或信号输出 NaN/异常值级联扩散。
5. **计算延迟**：信号计算耗时过长，实盘场景下信号产出时行情已过期，决策失效。

---

## 4. Backtest（回测编排与结果）

### A. 职责（做什么）

- 回测任务的创建、参数配置与提交
- 时间区间、初始资金、手续费率、滑点模型等回测环境配置
- 时间推进与事件驱动的模拟执行编排
- 撮合模拟（模拟成交价格、成交量限制、涨跌停处理）
- 回测过程中持仓、资金、订单的快照记录
- 回测结果（收益曲线、交易明细、统计指标）的产出与存储

### B. 边界（不做什么）

- **不负责** 真实订单的下发与成交（由 Execution、OrderTrade 承载）
- **不负责** 策略定义与版本管理（由 Strategy 承载）
- **不负责** 原始行情数据的存储（由 MarketData 承载）
- **不负责** 因子/信号的计算逻辑（由 Signal 承载）
- **不负责** 绩效归因与多策略对比分析（由 Analytics 承载）
- **不负责** 实盘账本的记账（由 Ledger 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **时间单向**：回测时间只能向前推进，不可回退；任何决策只能基于"当前时点及之前"的数据。
2. **资金守恒**：任意时点，现金 + 持仓市值 + 冻结资金 = 总权益（不考虑费用时）；考虑费用时差额必须等于已扣费用。
3. **订单-成交一致**：回测内的模拟订单与模拟成交必须一一对应，成交数量 ≤ 订单数量。
4. **结果可复现**：给定相同策略版本、相同参数、相同历史数据，多次回测结果必须完全一致。
5. **无真实副作用**：回测过程不得触发任何真实订单、真实资金变动或真实持仓变更。
6. **快照完整**：回测结束后，必须能还原任意时点的持仓、资金、订单状态，支持事后审计。

### D. 常见失败模式

1. **未来数据泄漏**：撮合时使用了当前 Bar 的收盘价作为开盘决策依据，导致收益虚高。
2. **滑点/费用遗漏**：未计入手续费、印花税、滑点，导致回测收益与实盘偏差大。
3. **成交量穿透**：模拟成交量超过当日实际成交量，导致大资金回测不可复现。
4. **涨跌停忽略**：涨停时仍允许买入、跌停时仍允许卖出，导致回测结果不切实际。
5. **随机性不可控**：若策略或撮合有随机因素，未固定随机种子，导致多次回测结果不一致。

---

## 5. Execution（下单执行通道）

### A. 职责（做什么）

- 交易指令（来自策略或人工）到交易所/经纪商订单的转化
- 多通道（不同交易所、不同经纪商）的统一抽象与适配
- 订单的提交、撤单、改单请求的发送
- 执行状态（已报、已成、部成、已撤、废单）的接收与转发
- 执行质量（滑点、延迟、成交率）的度量采集
- 通道健康监控与故障切换

### B. 边界（不做什么）

- **不负责** 订单/成交的持久化与事实记录（由 OrderTrade 承载）
- **不负责** 持仓的更新与管理（由 Position 承载）
- **不负责** 资金的冻结、扣减与记账（由 Ledger 承载）
- **不负责** 策略信号的产出（由 Signal、Strategy 承载）
- **不负责** 风控规则的定义与执行（由独立风控模块或 Strategy 层承载）
- **不负责** 回测场景的模拟撮合（由 Backtest 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **订单唯一性**：每笔提交到通道的订单必须有全局唯一标识（平台订单号），不因通道重连/重试而重复。
2. **幂等提交**：同一订单因网络重试多次提交时，通道或平台必须保证只执行一次。
3. **状态同步**：通道返回的订单状态必须及时、完整地同步到 OrderTrade，不丢失任何状态变更。
4. **成交不可撤**：已成交的部分不可撤销，撤单只能撤销未成交部分。
5. **通道隔离**：不同通道的订单/成交不混淆，通道标识贯穿订单全生命周期。
6. **时间戳保真**：必须记录通道返回的原始时间戳，不可用本地时间替代。

### D. 常见失败模式

1. **重复下单**：网络超时后重试，未做幂等，导致同一信号下出多笔订单。
2. **状态丢失**：通道回调未正确处理或消息队列丢消息，导致订单状态与实际不符。
3. **撤单竞态**：撤单请求与成交回报并发，处理顺序错误导致"已撤"却有成交。
4. **通道混用**：多通道场景下订单号冲突或路由错误，导致张冠李戴。
5. **时间戳覆盖**：用本地接收时间覆盖通道原始时间，导致执行质量分析失真。

---

## 6. OrderTrade（订单/成交流水）

### A. 职责（做什么）

- 订单的持久化存储（创建、状态变更、终态）
- 成交流水的持久化存储（成交价、成交量、成交时间、手续费）
- 订单与成交的关联（一笔订单可有多笔成交）
- 提供订单/成交的查询能力（按时间、标的、状态、策略等维度）
- 作为 Position、Ledger、Analytics 的上游事实来源

### B. 边界（不做什么）

- **不负责** 订单的提交与通道交互（由 Execution 承载）
- **不负责** 持仓数量的计算与更新（由 Position 承载）
- **不负责** 资金的冻结与扣减（由 Ledger 承载）
- **不负责** 执行质量的分析与报表（由 Analytics 承载）
- **不负责** 回测场景的模拟订单（由 Backtest 承载，回测订单与实盘订单物理隔离）

### C. 不变量（必须永远成立的正确性规则）

1. **成交 ≤ 订单**：任一订单的累计成交数量永远 ≤ 订单数量。
2. **成交不可逆**：成交记录一旦写入，不可删除或修改（除非走显式冲正流程并留痕）。
3. **订单状态机合法**：订单状态只能按合法路径流转（如：已报→部成→全成），不允许非法跳跃。
4. **时间有序**：同一订单的成交时间序列必须单调递增，不可乱序。
5. **关联完整**：每笔成交必须关联到唯一订单；每笔订单必须关联到策略实例或人工来源。
6. **租户隔离**：订单/成交归属租户，跨租户不可见、不可查询。

### D. 常见失败模式

1. **重复成交**：同一笔通道成交因重试/回调重复写入，导致成交数量虚增。
2. **订单孤儿**：订单创建后通道报错，但订单记录未更新为废单，长期处于"已报"假状态。
3. **成交漏记**：通道成交回调丢失或处理异常，导致实际已成交但系统无记录。
4. **状态错乱**：并发更新订单状态未加锁，导致状态跳跃或回退。
5. **跨租户泄漏**：查询接口未校验租户，导致 A 租户看到 B 租户订单。

---

## 7. Position（持仓）

### A. 职责（做什么）

- 标的级别的持仓数量管理（多头/空头、可用/冻结）
- 持仓成本的计算与更新（成本价、浮动盈亏）
- 持仓变动的记录（因成交、调仓、强平等）
- 提供当前持仓快照与历史持仓查询
- 支持多账户、多币种、多市场的持仓隔离

### B. 边界（不做什么）

- **不负责** 成交流水的记录（由 OrderTrade 承载）
- **不负责** 资金/权益的记账（由 Ledger 承载）
- **不负责** 订单的下发与状态管理（由 Execution、OrderTrade 承载）
- **不负责** 持仓的收益归因分析（由 Analytics 承载）
- **不负责** 行情价格的获取（由 MarketData 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **持仓 = Σ成交**：任一标的的当前持仓数量 = 该标的所有买入成交数量 - 所有卖出成交数量（含调整）。
2. **可用 + 冻结 = 总持仓**：任一标的的可用数量 + 冻结数量 = 总持仓数量。
3. **卖出 ≤ 可用**：卖出/平仓数量不得超过可用持仓数量。
4. **成本可追溯**：持仓成本必须能从成交明细反推得出（加权平均、先进先出等，口径需明确）。
5. **变动有来源**：每一笔持仓变动必须关联到成交、调仓、强平或系统事件，不允许无源变动。
6. **租户隔离**：持仓归属租户+账户，跨租户/跨账户不可见。

### D. 常见失败模式

1. **成交未同步**：成交已入库但持仓未更新，导致持仓与成交不一致。
2. **冻结未释放**：订单撤单后冻结持仓未释放，导致可用持仓长期偏低。
3. **超卖**：可用数量校验缺失，导致卖出数量超过实际可用。
4. **成本计算错误**：部分成交时成本计算公式错误，导致浮动盈亏失真。
5. **多账户混淆**：同一租户多账户场景下，持仓查询未区分账户，导致数据混淆。

---

## 8. Ledger（资金/权益/费用/账务）

### A. 职责（做什么）

- 资金账户的余额管理（可用、冻结、总权益）
- 资金变动的记账（入金、出金、成交扣款、手续费、利息、分红等）
- 权益快照的定时/事件触发计算（净值、收益率）
- 费用的计提与扣减（手续费、印花税、过户费、融资利息等）
- 提供账务流水查询与对账能力
- 支持多币种、多账户的账务隔离

### B. 边界（不做什么）

- **不负责** 成交流水的原始记录（由 OrderTrade 承载）
- **不负责** 持仓数量的管理（由 Position 承载）
- **不负责** 订单的下发（由 Execution 承载）
- **不负责** 外部银行/支付通道的对接（由独立出入金模块承载）
- **不负责** 收益归因与绩效分析（由 Analytics 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **借贷平衡**：任一时点，所有账务分录的借方合计 = 贷方合计（复式记账）。
2. **资金守恒**：可用 + 冻结 = 总余额；总权益 = 现金余额 + 持仓市值（按约定估值口径）。
3. **流水可追溯**：任一余额变动必须有对应的账务流水，流水必须关联到业务来源（成交、入金、费用等）。
4. **PnL 可推导**：盈亏只能由成交、持仓市值变动、费用等账务事件推导得出，不允许直接修改 PnL。
5. **费用不遗漏**：每笔成交的手续费、税费必须在账务中体现，不允许成交无费用记录。
6. **租户隔离**：账务归属租户+账户，跨租户/跨账户不可见、不可操作。
7. **不可逆变更留痕**：任何账务冲正/调账必须走显式流程并保留原始记录与调整原因。

### D. 常见失败模式

1. **重复记账**：同一笔成交因重试/回调重复写入账务流水，导致资金多扣或多增。
2. **费用遗漏**：成交入账但手续费未扣，导致账面资金高于实际。
3. **冻结泄漏**：订单撤单后冻结资金未释放，导致可用资金长期偏低。
4. **对账差异**：账务流水与成交流水口径不一致，导致对账永远有差。
5. **币种混淆**：多币种场景下汇率处理错误或币种字段缺失，导致资金计算错误。
6. **权益快照延迟**：净值计算依赖的行情延迟或缺失，导致权益快照不准确。

---

## 9. Analytics（指标/报表/归因）

### A. 职责（做什么）

- 绩效指标计算（收益率、年化收益、夏普比率、最大回撤等）
- 风险指标计算（波动率、VaR、Beta 等）
- 收益归因分析（按标的、按行业、按因子、按时间段）
- 交易行为分析（胜率、盈亏比、持仓周期、换手率等）
- 报表与可视化数据的产出（仅数据层面，不含 UI 实现）
- 支持回测结果与实盘结果的对比分析

### B. 边界（不做什么）

- **不负责** 原始成交/订单的记录（由 OrderTrade 承载）
- **不负责** 持仓/资金的实时管理（由 Position、Ledger 承载）
- **不负责** 行情数据的采集（由 MarketData 承载）
- **不负责** 报表的前端展示与交互（由 Apps 层承载）
- **不负责** 策略的修改或执行（由 Strategy、Execution 承载）

### C. 不变量（必须永远成立的正确性规则）

1. **指标可复现**：给定相同的输入数据（成交、持仓、净值序列），指标计算结果必须完全一致。
2. **口径一致**：同一指标在回测与实盘中必须使用相同的计算公式与口径。
3. **数据来源明确**：所有指标的输入数据必须来自 OrderTrade、Position、Ledger、MarketData，不可凭空捏造。
4. **时间对齐**：归因分析中使用的行情、持仓、成交数据必须在时间维度上对齐，不可错配。
5. **无反向写入**：Analytics 只读取上游数据，不可反向修改 OrderTrade、Position、Ledger。

### D. 常见失败模式

1. **口径不一致**：回测收益率与实盘收益率使用不同计算公式，导致对比失真。
2. **数据延迟**：归因分析使用的持仓/净值快照滞后于实际，导致归因结果错误。
3. **除零/溢出**：计算夏普比率等指标时未处理零波动或极端值，导致 NaN 或无穷大。
4. **时间错配**：将 T 日的持仓与 T+1 日的行情匹配计算市值，导致收益率计算错误。
5. **归因不闭合**：各归因项之和不等于总收益，违反归因完整性。

---

## 依赖方向图（文字版）

以下为 9 个能力域的依赖方向，依赖只能单向流动，形成有向无环图（DAG）。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              依赖方向图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   MarketData ──────┬──────────────────────────────────────────────────┐     │
│        │           │                                                  │     │
│        ▼           │                                                  ▼     │
│     Signal ────────┼───────────────────────────────────────────► Analytics  │
│        │           │                                                  ▲     │
│        ▼           │                                                  │     │
│    Strategy ───────┤                                                  │     │
│        │           │                                                  │     │
│        ├───────────┼──────────► Backtest ─────────────────────────────┤     │
│        │           │               │                                  │     │
│        ▼           │               │ (回测产出模拟订单/持仓/资金)      │     │
│    Execution       │               ▼                                  │     │
│        │           │         [回测内部闭环，不写入实盘 OrderTrade]      │     │
│        ▼           │                                                  │     │
│   OrderTrade ──────┼───────────────────────────────────────────────────┤     │
│        │           │                                                  │     │
│        ├───────────┼──────────► Position ─────────────────────────────┤     │
│        │           │               │                                  │     │
│        ▼           │               ▼                                  │     │
│     Ledger ────────┴───────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 依赖规则说明

| 上游 | 下游 | 依赖说明 |
|------|------|----------|
| MarketData | Signal | 因子计算依赖行情数据 |
| MarketData | Backtest | 回测撮合依赖历史行情 |
| MarketData | Analytics | 市值计算、归因依赖行情 |
| Signal | Strategy | 策略可引用因子/信号 |
| Strategy | Backtest | 回测执行策略定义 |
| Strategy | Execution | 实盘执行策略信号 |
| Execution | OrderTrade | 执行结果写入订单/成交 |
| OrderTrade | Position | 成交驱动持仓更新 |
| OrderTrade | Ledger | 成交驱动资金扣减/记账 |
| OrderTrade | Analytics | 成交是分析的事实来源 |
| Position | Ledger | 持仓市值影响权益计算 |
| Position | Analytics | 持仓是归因的输入 |
| Ledger | Analytics | 资金/权益是绩效的输入 |
| Backtest | Analytics | 回测结果供分析对比 |

### 禁止的反向依赖

- **禁止** Analytics 写回 OrderTrade/Position/Ledger
- **禁止** Ledger 修改 OrderTrade
- **禁止** Position 修改 OrderTrade
- **禁止** Execution 直接修改 Position/Ledger（必须经由 OrderTrade）
- **禁止** Backtest 写入实盘 OrderTrade/Position/Ledger

---

## 旧项目接入最低契约（Planning 版）

本节定义旧项目作为 App 接入平台时的最低契约要求，仅列清单，不涉及具体接口字段。

### 一、旧项目可提供的能力（允许复用）

以下能力允许旧项目作为 App 层实现提供，平台不强制重建：

| 能力域 | 旧项目可提供的输入/输出 | 备注 |
|--------|-------------------------|------|
| Strategy | 策略定义、参数配置、版本管理 | 需适配平台策略元数据格式 |
| MarketData | 行情采集、数据存储、数据查询 | 需遵守平台时间戳与标的 ID 规范 |
| Signal | 因子计算逻辑、选股逻辑、信号产出 | 需保证无未来函数、可复现 |
| Backtest | 回测引擎、撮合模拟、结果产出 | 回测结果需按平台格式输出 |
| Analytics | 指标计算、报表数据产出 | 需基于平台 OrderTrade/Ledger 数据 |

### 二、平台必须重建并作为唯一事实来源的能力

以下能力因安全性、一致性、合规性要求，**必须由平台重建**，旧项目不得作为事实来源：

| 能力域 | 原因 | 旧项目角色 |
|--------|------|------------|
| **OrderTrade** | 订单/成交是持仓、资金、分析的唯一事实来源，必须由平台统一管理，确保不重复、不遗漏、可审计 | 旧项目只能通过 Execution 提交指令，不可直接写入 OrderTrade |
| **Position** | 持仓必须由 OrderTrade 驱动更新，确保与成交一致 | 旧项目只能读取 Position，不可直接修改 |
| **Ledger** | 资金/权益是对账与合规基础，必须由平台统一记账 | 旧项目只能读取 Ledger，不可直接修改 |
| **Execution**（通道层） | 订单下发必须经平台通道，确保幂等、审计、风控 | 旧项目可提供交易信号，但实际下单必须走平台 Execution |

### 三、接入时旧项目需满足的最低契约

1. **策略元数据适配**：旧项目的策略需能导出为平台定义的策略元数据格式（策略名、版本、参数模板）。
2. **信号输出标准化**：旧项目产出的买卖信号需包含：标的标识、方向、数量/权重、信号时间戳。
3. **回测结果格式化**：旧项目的回测结果需能转换为平台定义的回测结果格式（收益曲线、交易明细、统计指标）。
4. **行情数据对接**：若旧项目使用自有行情源，需保证时间戳、标的 ID 与平台规范一致，或通过适配层转换。
5. **只读访问 OrderTrade/Position/Ledger**：旧项目可通过平台提供的查询能力获取订单、持仓、资金数据，但不可直接写入。
6. **审计日志配合**：旧项目的关键操作需能输出日志供平台审计模块采集。

### 四、接入模式总结

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        旧项目接入模式                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│   │  旧项目 App  │      │  旧项目 App  │      │  旧项目 App  │            │
│   │ (Strategy)  │      │  (Signal)   │      │ (Backtest)  │            │
│   └──────┬──────┘      └──────┬──────┘      └──────┬──────┘            │
│          │                    │                    │                   │
│          ▼                    ▼                    ▼                   │
│   ┌─────────────────────────────────────────────────────────┐          │
│   │                    平台能力层                            │          │
│   │  ┌───────────┬───────────┬───────────┬───────────┐     │          │
│   │  │ Execution │ OrderTrade│ Position  │  Ledger   │     │          │
│   │  │  (重建)   │  (重建)   │  (重建)   │  (重建)   │     │          │
│   │  └───────────┴───────────┴───────────┴───────────┘     │          │
│   └─────────────────────────────────────────────────────────┘          │
│                              │                                         │
│                              ▼                                         │
│   ┌─────────────────────────────────────────────────────────┐          │
│   │                     Analytics                           │          │
│   │            (可复用旧项目，但必须基于平台数据)              │          │
│   └─────────────────────────────────────────────────────────┘          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 附：能力域与模块/应用对应关系

| 能力域 | 对应模块层（Module） | 可能的应用层（App） |
|--------|---------------------|---------------------|
| Strategy | 策略模块 | 策略工作台、策略市场 |
| MarketData | 数据模块 | 行情终端、数据管理 |
| Signal | 因子/信号模块 | 因子库、选股器 |
| Backtest | 回测模块 | 回测工作台、回测报告 |
| Execution | 执行模块 | 交易终端、算法交易 |
| OrderTrade | 订单模块 | 订单管理、成交查询 |
| Position | 持仓模块 | 持仓管理、持仓分析 |
| Ledger | 账务模块 | 资金管理、对账中心 |
| Analytics | 分析模块 | 绩效报表、风险报告、归因分析 |

---

*文档归属：SaaS 量化平台 Blueprint · 02 量化能力模型*
