# 能力覆盖与风险对照

本文档为规划阶段产出，遵循 `docs/PLANNING_ONLY.md` 的全局约束：仅输出能力对照、风险分析与验证清单，不涉及任何代码、表结构或接口实现。

**文档状态**：初版（基于假设，待补充项目信息后迭代）

---

## 一、能力覆盖矩阵（初版）

> 说明：在项目信息完整前，本矩阵基于"量化系统常见形态"给出初步判断。所有标注"未知"的单元格均列出"转为可判定"所需的证据。

| 能力域 | 项目 A | 项目 B | 项目 C |
|--------|--------|--------|--------|
| **Strategy** | 未知 / 中风险 | 未知 / 中风险 | 未知 / 中风险 |
| | 待补证据：是否有策略表、策略版本管理、参数配置表 | 待补证据：同左 | 待补证据：同左 |
| **MarketData** | 未知 / 中风险 | 未知 / 中风险 | 未知 / 中风险 |
| | 待补证据：行情表名、数据源类型、时间戳精度与时区、标的ID规范 | 待补证据：同左 | 待补证据：同左 |
| **Signal** | 未知 / 高风险 | 未知 / 高风险 | 未知 / 高风险 |
| | 待补证据：因子表/信号表、因子计算是否有未来函数、是否有因子版本管理 | 待补证据：同左 | 待补证据：同左 |
| **Backtest** | 未知 / 高风险 | 未知 / 高风险 | 未知 / 高风险 |
| | 待补证据：回测任务表、回测结果表、撮合逻辑说明、是否计滑点/费用 | 待补证据：同左 | 待补证据：同左 |
| **Execution** | 未知 / 极高风险 | 未知 / 极高风险 | 未知 / 极高风险 |
| | 待补证据：是否有实盘执行、通道类型、订单幂等机制、是否有重复下单历史 | 待补证据：同左 | 待补证据：同左 |
| **OrderTrade** | 未知 / 极高风险 | 未知 / 极高风险 | 未知 / 极高风险 |
| | 待补证据：订单表、成交表、订单状态机、是否有重复成交/漏成交历史 | 待补证据：同左 | 待补证据：同左 |
| **Position** | 未知 / 极高风险 | 未知 / 极高风险 | 未知 / 极高风险 |
| | 待补证据：持仓表、持仓与成交是否一致、是否支持多账户、成本计算口径 | 待补证据：同左 | 待补证据：同左 |
| **Ledger** | 未知 / 极高风险 | 未知 / 极高风险 | 未知 / 极高风险 |
| | 待补证据：资金表、流水表、费用记录、PnL计算口径、是否有对账机制 | 待补证据：同左 | 待补证据：同左 |
| **Analytics** | 未知 / 中风险 | 未知 / 中风险 | 未知 / 中风险 |
| | 待补证据：指标表/报表、指标计算公式、数据来源是否为OrderTrade/Ledger | 待补证据：同左 | 待补证据：同左 |

### 风险等级说明

| 风险等级 | 定义 | 能力域 |
|----------|------|--------|
| 极高 | 涉及资金安全、订单正确性、合规审计，错误不可逆 | Execution, OrderTrade, Position, Ledger |
| 高 | 涉及策略正确性、回测可信度，错误会导致决策失误 | Signal, Backtest |
| 中 | 涉及数据质量、策略管理、分析准确性 | Strategy, MarketData, Analytics |

---

## 二、最小信息需求清单（Minimal Info Required）

为将矩阵从"未知"变为"可判定"，每个项目需补充以下信息：

### 项目 A 需补充信息（10 条）

| # | 信息项 | 用途 | 优先级 |
|---|--------|------|--------|
| 1 | **核心表名 TOP15** | 映射到 9 个能力域，判断覆盖范围 | P0 |
| 2 | **是否有实盘执行能力** | 判断 Execution 覆盖度 | P0 |
| 3 | **订单表/成交表是否存在** | 判断 OrderTrade 覆盖度 | P0 |
| 4 | **持仓表是否存在，是否与成交联动** | 判断 Position 覆盖度与一致性 | P0 |
| 5 | **资金/流水表是否存在，PnL 如何计算** | 判断 Ledger 覆盖度与正确性 | P0 |
| 6 | **是否支持多账户/多币种** | 判断隔离边界与复杂度 | P1 |
| 7 | **回测是否计滑点/手续费/涨跌停** | 判断 Backtest 可信度 | P1 |
| 8 | **因子/信号是否有未来函数风险** | 判断 Signal 正确性 | P1 |
| 9 | **已知 Bug / 历史故障清单** | 识别高风险点 | P1 |
| 10 | **时间戳/时区处理方式** | 判断 MarketData 一致性 | P2 |

### 项目 B 需补充信息（10 条）

| # | 信息项 | 用途 | 优先级 |
|---|--------|------|--------|
| 1 | **核心表名 TOP15** | 映射到 9 个能力域，判断覆盖范围 | P0 |
| 2 | **是否有实盘执行能力** | 判断 Execution 覆盖度 | P0 |
| 3 | **订单表/成交表是否存在** | 判断 OrderTrade 覆盖度 | P0 |
| 4 | **持仓表是否存在，是否与成交联动** | 判断 Position 覆盖度与一致性 | P0 |
| 5 | **资金/流水表是否存在，PnL 如何计算** | 判断 Ledger 覆盖度与正确性 | P0 |
| 6 | **是否支持多账户/多币种** | 判断隔离边界与复杂度 | P1 |
| 7 | **回测是否计滑点/手续费/涨跌停** | 判断 Backtest 可信度 | P1 |
| 8 | **因子/信号是否有未来函数风险** | 判断 Signal 正确性 | P1 |
| 9 | **已知 Bug / 历史故障清单** | 识别高风险点 | P1 |
| 10 | **时间戳/时区处理方式** | 判断 MarketData 一致性 | P2 |

### 项目 C 需补充信息（10 条）

| # | 信息项 | 用途 | 优先级 |
|---|--------|------|--------|
| 1 | **核心表名 TOP15** | 映射到 9 个能力域，判断覆盖范围 | P0 |
| 2 | **是否有实盘执行能力** | 判断 Execution 覆盖度 | P0 |
| 3 | **订单表/成交表是否存在** | 判断 OrderTrade 覆盖度 | P0 |
| 4 | **持仓表是否存在，是否与成交联动** | 判断 Position 覆盖度与一致性 | P0 |
| 5 | **资金/流水表是否存在，PnL 如何计算** | 判断 Ledger 覆盖度与正确性 | P0 |
| 6 | **是否支持多账户/多币种** | 判断隔离边界与复杂度 | P1 |
| 7 | **回测是否计滑点/手续费/涨跌停** | 判断 Backtest 可信度 | P1 |
| 8 | **因子/信号是否有未来函数风险** | 判断 Signal 正确性 | P1 |
| 9 | **已知 Bug / 历史故障清单** | 识别高风险点 | P1 |
| 10 | **时间戳/时区处理方式** | 判断 MarketData 一致性 | P2 |

---

## 三、能力清单（初步假设版）

### A. 完全重复的能力（适合平台化统一）

基于量化系统常见形态，以下能力大概率在三个项目中重复存在，适合抽取到平台层统一：

| # | 能力 | 候选原因 | 验证状态 |
|---|------|----------|----------|
| 1 | **行情数据存储与查询**（MarketData） | 所有量化系统都需要 K 线/Tick 数据，重复建设浪费 | 需验证：三项目是否都有行情表 |
| 2 | **策略参数配置**（Strategy） | 策略参数管理是通用需求 | 需验证：三项目策略表结构差异 |
| 3 | **回测任务管理**（Backtest） | 回测任务提交/状态/结果是通用流程 | 需验证：回测结果格式差异 |
| 4 | **绩效指标计算**（Analytics） | 收益率/夏普/回撤等指标计算公式通用 | 需验证：指标口径是否一致 |
| 5 | **标的主数据**（MarketData） | 股票/期货代码、名称、交易日历等通用 | 需验证：标的 ID 规范差异 |

**平台化收益**：统一后可减少重复开发、统一数据口径、降低维护成本。

### B. 差异能力候选（保留为 App 差异点）

以下能力可能在三个项目中存在差异，强行统一会破坏业务价值，建议保留为 App 层差异：

| # | 差异能力 | 可能的差异点 | 验证状态 |
|---|----------|--------------|----------|
| 1 | **市场/标的类型** | A股 vs 港股 vs 期货 vs 数字货币 | 需验证：各项目覆盖市场 |
| 2 | **因子库/选股逻辑**（Signal） | 不同策略团队有不同因子体系 | 需验证：因子是否可共享 |
| 3 | **撮合模型**（Backtest） | 不同市场的涨跌停/T+0/T+1 规则不同 | 需验证：各项目撮合规则 |
| 4 | **费用模型**（Ledger） | 不同市场/券商费率结构不同 | 需验证：费用计算逻辑差异 |
| 5 | **执行通道**（Execution） | 不同券商/交易所 API 不同 | 需验证：各项目对接通道 |
| 6 | **策略类型** | 趋势 vs 套利 vs 高频，逻辑差异大 | 需验证：策略类型分布 |
| 7 | **报表样式**（Analytics） | 不同用户对报表格式有不同偏好 | 需验证：报表差异程度 |

**保留差异原因**：这些差异是业务价值的体现，强行统一会导致功能退化或复杂度爆炸。

### C. 必须重建的能力（即使未知也必须重建）

以下能力因安全性、一致性、合规性要求，**无论旧项目覆盖度如何，都必须由平台重建**：

| # | 能力域 | 必须重建原因 | 不变量依据（引用 02 文档） |
|---|--------|--------------|---------------------------|
| 1 | **Execution** | 订单下发必须保证幂等、不重复、可审计；旧系统若无统一幂等机制，会导致重复下单 | "订单唯一性"、"幂等提交" 不变量无法在未知系统中保证 |
| 2 | **OrderTrade** | 订单/成交是 Position、Ledger、Analytics 的唯一事实来源；若旧系统有重复成交、漏记成交，会导致下游全部错误 | "成交≤订单"、"成交不可逆"、"关联完整" 不变量无法在未知系统中保证 |
| 3 | **Position** | 持仓必须由成交驱动更新，且满足"持仓=Σ成交"；若旧系统持仓与成交不一致，会导致超卖或资金计算错误 | "持仓=Σ成交"、"卖出≤可用" 不变量无法在未知系统中保证 |
| 4 | **Ledger** | 资金是对账与合规基础；若旧系统存在重复记账、费用遗漏、PnL 不可推导，会导致资金不可信 | "借贷平衡"、"资金守恒"、"PnL可推导"、"费用不遗漏" 不变量无法在未知系统中保证 |

**重建策略**：

- 旧项目可作为 **App 层**（Strategy、Signal、Backtest、Analytics）接入平台
- 旧项目的 Execution/OrderTrade/Position/Ledger **只能作为历史数据参考**，不能作为事实来源
- 新平台的 Execution/OrderTrade/Position/Ledger 作为 **唯一写入点**，旧系统只读访问

---

## 四、待验证清单（第一版）

### 1. Strategy 验证点（3 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| S-1 | 策略是否有版本管理 | 策略表是否有 version 字段、历史版本是否可查 | 无法追溯历史回测/实盘用的是哪个版本，复现失败 |
| S-2 | 策略参数是否与版本绑定 | 回测/实盘记录是否关联策略参数快照 | 参数漂移导致收益归因失真 |
| S-3 | 策略状态流转是否合法 | 是否有状态字段、是否有未发布策略进入生产的历史 | 未审核策略进入实盘，风控失效 |

### 2. MarketData 验证点（3 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| M-1 | 时间戳是否统一时区 | 行情表时间戳字段、是否有 UTC/本地混用 | 因子计算时间错位，回测结果不可信 |
| M-2 | 标的 ID 是否唯一规范 | 是否有市场前缀、是否有同代码不同市场的冲突 | 数据串标的，下单下错品种 |
| M-3 | 是否有数据缺失检测 | 是否有数据质量表/告警、停牌日如何处理 | 缺失数据导致因子 NaN、回测失真 |

### 3. Signal 验证点（3 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| G-1 | 因子是否有未来函数 | 因子计算逻辑说明、是否用到当日收盘价计算当日开盘信号 | 回测虚高、实盘失效，策略不可用 |
| G-2 | 因子是否有版本管理 | 因子表是否有 version、历史因子值是否可查 | 因子漂移导致归因失真 |
| G-3 | 空值如何处理 | 因子计算遇缺失数据时的处理逻辑 | 空值传播导致信号异常、下单错误 |

### 4. Backtest 验证点（3 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| B-1 | 是否计入滑点与手续费 | 回测配置表/回测报告、费用参数 | 回测收益与实盘偏差大，策略选择失误 |
| B-2 | 是否处理涨跌停 | 撮合逻辑说明、涨停日是否阻止买入 | 回测买入不切实际的标的，收益虚高 |
| B-3 | 回测是否可复现 | 相同参数多次回测结果是否一致、是否有随机因素 | 无法复现导致策略验证失效 |

### 5. Execution 验证点（8 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| E-1 | 是否有实盘执行能力 | 是否对接券商/交易所 API、是否有实盘订单记录 | 若无，则 Execution 能力缺失，需完全新建 |
| E-2 | 订单是否有唯一标识 | 订单表主键、是否有平台订单号 | 无唯一标识导致重复下单无法检测 |
| E-3 | 是否有幂等机制 | 网络重试时是否会重复下单、历史是否有重复下单事故 | 重复下单导致资金损失 |
| E-4 | 订单状态是否完整同步 | 是否有状态丢失、撤单与成交并发处理逻辑 | 状态不一致导致持仓/资金计算错误 |
| E-5 | 通道是否有隔离 | 多通道场景下订单号是否冲突、是否有路由错误历史 | 订单张冠李戴，成交归错账户 |
| E-6 | 时间戳是否保真 | 是否保留通道原始时间戳、是否用本地时间覆盖 | 执行质量分析失真 |
| E-7 | 是否有风控前置 | 下单前是否有金额/数量/频率校验 | 无风控导致异常订单直接下发 |
| E-8 | 通道故障如何处理 | 通道超时/断连时的处理逻辑、是否有切换机制 | 故障时订单状态不确定，需人工介入 |

### 6. OrderTrade 验证点（8 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| O-1 | 订单表是否存在 | 表名、核心字段（订单号、状态、数量、价格、时间） | 若无，OrderTrade 能力缺失，需完全新建 |
| O-2 | 成交表是否存在 | 表名、核心字段（成交号、订单号、成交价、成交量、时间） | 若无，成交流水缺失，Position/Ledger 无来源 |
| O-3 | 成交是否可能重复 | 是否有重复成交的历史、成交写入是否幂等 | 重复成交导致持仓/资金翻倍错误 |
| O-4 | 成交是否可能遗漏 | 是否有漏记成交的历史、消息丢失如何处理 | 漏记成交导致持仓/资金偏低 |
| O-5 | 订单状态机是否合法 | 状态流转是否有约束、是否有非法跳跃历史 | 状态错乱导致订单假"已报"或假"已撤" |
| O-6 | 成交时间是否有序 | 同一订单多笔成交时间是否单调递增 | 乱序导致成本计算（如 FIFO）错误 |
| O-7 | 订单与策略是否关联 | 订单是否有策略 ID/来源字段 | 无关联导致无法按策略归因 |
| O-8 | 租户隔离是否存在 | 是否有租户字段、跨租户查询是否有校验 | 无隔离导致数据泄漏 |

### 7. Position 验证点（8 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| P-1 | 持仓表是否存在 | 表名、核心字段（标的、数量、成本、账户） | 若无，Position 能力缺失，需完全新建 |
| P-2 | 持仓是否与成交一致 | 持仓数量 = Σ买入 - Σ卖出 是否成立、是否有校验 | 不一致导致超卖或浮盈计算错误 |
| P-3 | 可用与冻结是否分开 | 是否有 available/frozen 字段、下单时是否冻结 | 无区分导致超卖 |
| P-4 | 冻结是否正确释放 | 撤单后冻结是否释放、是否有冻结泄漏历史 | 冻结泄漏导致可用持仓长期偏低 |
| P-5 | 成本计算口径是否明确 | 加权平均 vs FIFO vs LIFO、口径是否一致 | 口径不明导致浮盈计算不可比 |
| P-6 | 多账户是否隔离 | 是否有账户字段、不同账户持仓是否混淆 | 无隔离导致不同账户持仓串用 |
| P-7 | 持仓变动是否有来源 | 每笔变动是否关联成交/调仓/事件 | 无来源导致变动不可审计 |
| P-8 | 是否支持空头持仓 | 是否有多头/空头标识、做空场景如何处理 | 若不支持且业务需要，则能力缺失 |

### 8. Ledger 验证点（8 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| L-1 | 资金表是否存在 | 表名、核心字段（余额、可用、冻结、币种、账户） | 若无，Ledger 能力缺失，需完全新建 |
| L-2 | 流水表是否存在 | 表名、核心字段（金额、类型、关联业务、时间） | 若无，资金变动不可追溯 |
| L-3 | 是否可能重复记账 | 是否有重复入账历史、流水写入是否幂等 | 重复记账导致资金虚增 |
| L-4 | 费用是否完整记录 | 成交是否有对应费用流水、费用类型是否全 | 费用遗漏导致账面资金高于实际 |
| L-5 | PnL 如何计算 | PnL 是直接存储还是从流水推导、口径是否明确 | 直接存储且可被修改则不可信 |
| L-6 | 冻结是否正确释放 | 撤单后冻结资金是否释放、是否有冻结泄漏历史 | 冻结泄漏导致可用资金长期偏低 |
| L-7 | 多币种如何处理 | 是否有币种字段、汇率如何处理、是否有币种混淆历史 | 币种混淆导致资金计算错误 |
| L-8 | 是否有对账机制 | 是否定期与成交流水对账、对账差异如何处理 | 无对账导致错误长期累积不发现 |

### 9. Analytics 验证点（3 条）

| # | 验证目标 | 需要的证据 | 若失败的影响 |
|---|----------|------------|--------------|
| A-1 | 指标数据来源是否正确 | 收益率/夏普等指标是否基于 OrderTrade/Ledger 计算 | 数据来源错误导致指标不可信 |
| A-2 | 回测与实盘口径是否一致 | 回测收益率与实盘收益率计算公式是否相同 | 口径不一致导致对比失真 |
| A-3 | 归因是否闭合 | 各归因项之和是否等于总收益 | 归因不闭合导致分析无意义 |

---

## 五、项目信息补充区

> 请在此处补充三个项目的信息，补充后本文档将迭代更新矩阵与清单。

### 项目 A

**项目名称**：

**核心表名 TOP15**：

**是否有实盘执行**：

**已知 Bug / 历史故障**：

**其他备注**：

---

### 项目 B

**项目名称**：

**核心表名 TOP15**：

**是否有实盘执行**：

**已知 Bug / 历史故障**：

**其他备注**：

---

### 项目 C

**项目名称**：

**核心表名 TOP15**：

**是否有实盘执行**：

**已知 Bug / 历史故障**：

**其他备注**：

---

## 六、迭代记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v0.1 | - | 初版：基于假设产出矩阵、清单、验证点，待项目信息补充后迭代 |

---

*文档归属：SaaS 量化平台 Blueprint · 03 能力覆盖与风险对照*
