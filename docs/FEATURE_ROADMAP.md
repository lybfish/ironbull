# IronBull 功能路线图

> 本文档整理了平台尚未开发的功能需求，按优先级分类。  
> 每个功能标注了预估工作量和价值评级，可按需排期开发。  
> 更新时间：2026-02-08

---

## 一、高优先级（P1）

### 1. RBAC 权限管理（角色与权限）
- **现状**：所有管理员权限相同，无角色区分
- **目标**：
  - 定义角色（超级管理员 / 运营 / 财务 / 只读观察）
  - 按模块分配权限（如财务角色只能操作提现和点卡）
  - 前端菜单根据角色动态显示/隐藏
  - 后端 API 按角色鉴权
- **涉及**：`libs/admin/models.py` 新增 Role 表、`data-api` 鉴权中间件、`evui` 路由守卫
- **工作量**：大（3-5天）
- **价值**：高 — 多人协作运营的基础

### 2. Webhook 通知系统
- **现状**：仅有 Telegram 系统告警，无面向租户的事件通知
- **目标**：
  - 租户可配置 Webhook 回调 URL
  - 支持事件订阅（订单成交、止盈止损触发、提现审批、策略启停等）
  - Webhook 重试机制（失败自动重试 3 次，指数退避）
  - 后台可查看 Webhook 投递日志
- **涉及**：新增 `libs/notify/webhook.py`、`dim_webhook_config` 表、`fact_webhook_log` 表
- **工作量**：中（2-3天）
- **价值**：高 — 租户集成的关键能力

### 3. 风控配置 UI + 自动化动作
- **现状**：`libs/risk/engine.py` 有基础规则（余额、持仓数、日亏损限制），但无 UI 配置入口
- **目标**：
  - 管理后台增加"风控规则"配置页面
  - 可视化设置阈值（最小余额、最大持仓数、日亏损上限等）
  - 按租户/策略/用户维度配置不同规则
  - 触发告警时自动执行动作（停止策略、发通知、减仓等）
  - 风控告警历史记录和统计
- **涉及**：`libs/risk/` 配置表、`data-api` 风控配置 API、`evui` 风控管理页面
- **工作量**：中（2-3天）
- **价值**：高 — 资金安全核心保障

---

## 二、中优先级（P2）

### 4. 数据导出 CSV/Excel
- **现状**：所有数据页面只能在线查看，不支持导出
- **目标**：
  - 订单、成交、持仓、资金流水支持导出 CSV
  - 提现记录、点卡流水、奖励记录支持导出
  - 前端加"导出"按钮，后端可选流式生成
- **涉及**：`evui` 各列表页面加导出按钮、后端可复用现有列表接口（前端导出即可）
- **工作量**：小（1天）
- **价值**：高 — 日常运营高频需求

### 5. 手续费/佣金管理
- **现状**：无手续费配置功能
- **目标**：
  - 按租户配置交易手续费率
  - 按用户等级设定不同费率
  - 手续费统计报表
- **涉及**：新增 `dim_fee_config` 表、`data-api` 费率配置 API、`evui` 费率管理页面
- **工作量**：中（2天）
- **价值**：中

### 6. 交易对管理
- **现状**：市场信息只能浏览（同步页面的"市场信息"Tab），不能管控
- **目标**：
  - 按租户配置可交易币对白名单/黑名单
  - 一键启用/禁用某个交易对
  - 按用户限制可交易品种
- **涉及**：新增 `dim_trading_pair_config` 表、信号/执行流程中增加交易对校验
- **工作量**：中（2天）
- **价值**：中

### 7. 用户行为分析
- **现状**：没有用户活跃度/留存分析
- **目标**：
  - 用户活跃度指标（日活/月活）
  - 用户交易量排行
  - 留存分析（7日/30日留存率）
  - 用户分层（按交易量、盈亏、等级）
- **涉及**：`data-api` 新增分析接口、`evui` 新增分析页面
- **工作量**：中（2-3天）
- **价值**：中

### 8. EquitySnapshot 定时快照任务
- **现状**：`libs/analytics/models.py` 已有 `EquitySnapshot` 模型，但无定时快照任务
- **目标**：
  - 定时任务每日对所有账户做净值快照
  - 支撑绩效分析的历史净值曲线数据
- **涉及**：新增定时任务脚本（可放 `scripts/` 或 `deploy/cron/`）
- **工作量**：小（0.5天）
- **价值**：中 — 绩效分析数据基础

### 9. 配额强制执行
- **现状**：`Tenant.quota_plan_id` 和 `QuotaPlan` 模型已有，但创建用户/绑定策略时未校验配额
- **目标**：
  - 在创建用户、绑定策略、添加交易账户等操作时检查配额限制
  - 超限时拒绝操作并返回明确提示
- **涉及**：`libs/quota/service.py` 增加检查逻辑、各创建 API 增加配额校验
- **工作量**：小（1天）
- **价值**：中 — 多租户商业化基础

### 10. 批量操作增强
- **现状**：仅有批量分配节点
- **目标**：
  - 批量启用/禁用用户
  - 批量点卡充值
  - 批量策略绑定/解绑
  - 批量导入用户（CSV）
- **涉及**：`data-api` 批量 API、`evui` 批量操作 UI
- **工作量**：中（2天）
- **价值**：中

---

## 三、低优先级（P3）

### 11. API Key 管理增强
- **现状**：租户只有一组 `app_key`/`app_secret`，无法轮换
- **目标**：
  - 支持多组 API Key
  - Key 轮换（生成新的、废弃旧的）
  - Key 用量统计
  - Key 过期时间配置
- **工作量**：中（2天）
- **价值**：低

### 12. 定时报告（日报/周报/月报）
- **现状**：无报告生成功能
- **目标**：
  - 自动生成日报/周报/月报（PnL、交易量、用户增长等）
  - 邮件定时发送
  - 可配置报告模板和收件人
- **工作量**：大（3-4天）
- **价值**：中

### 13. 邮件通知
- **现状**：仅有 Telegram 通知
- **目标**：
  - SMTP 邮件发送能力
  - 注册确认、提现审批结果、风控告警等场景的邮件通知
  - 邮件模板管理
- **涉及**：新增 `libs/notify/email.py`
- **工作量**：中（1-2天）
- **价值**：低

### 14. 公告/广播系统
- **现状**：无面向用户的公告功能
- **目标**：
  - 管理员发布公告（全平台或指定租户）
  - 公告展示（Merchant API 返回、或前端弹窗）
  - 定时发布、过期自动下线
- **工作量**：中（2天）
- **价值**：低

### 15. 租户独立后台
- **现状**：租户通过 Merchant API 操作，无独立管理界面
- **目标**：
  - 给租户一个独立的 Web 管理面板
  - 租户可自助管理用户、查看数据、配置策略参数
- **工作量**：大（5-7天，需要新建前端项目）
- **价值**：中 — 提升租户自助能力

### 16. 审计日志增强
- **现状**：基础审计日志表和查询
- **目标**：
  - 审计日志导出 CSV/Excel
  - 更细粒度的操作记录（变更前后对比）
  - 合规报告生成
- **工作量**：中（1-2天）
- **价值**：低

### 17. 系统监控增强
- **现状**：基础服务健康检查和节点状态
- **目标**：
  - API 延迟指标和监控
  - 错误率追踪和告警
  - 历史监控数据和趋势
  - 集成 Prometheus/Grafana
- **工作量**：大（3-5天）
- **价值**：低（生产环境后优先级会提升）

---

## 已完成的功能清单

| 功能 | 完成时间 | 说明 |
|------|---------|------|
| 策略 CRUD（新建/删除） | 2026-02 | 后端 API + 前端 UI |
| 策略绑定删除 | 2026-02 | 后端 API + 前端 UI |
| 结算流程防静默失败 | 2026-02 | settlement.py 增加结果检查 |
| 奖励分发失败错误处理 | 2026-02 | pointcard/service.py 增强 |
| 前端死代码清理 | 2026-02 | 删除 dict.js、analysis.vue |
| 日志轮转 | 2026-02 | deploy/start.sh + logrotate.conf |
| 路由重复修复 | 2026-02 | users.py 移除重复 GET /users/{id} |
| get_balance 错误语义修复 | 2026-02 | 改为抛异常，不再静默返回 {} |
| 利润池失败重试机制 | 2026-02 | 后端 API + 前端管理页面 |
| Dashboard 数据可视化 | 2026-02 | 趋势 API + ECharts 图表（订单量/用户增长/成交额/利润池） |

---

## 数据库迁移备忘

以下功能需要数据库表变更，开发前需先执行 DDL：

```sql
-- 利润池重试字段（已实现，需执行）
ALTER TABLE fact_profit_pool
  ADD COLUMN retry_count INT NOT NULL DEFAULT 0 COMMENT '重试次数' AFTER status,
  ADD COLUMN last_error VARCHAR(500) NULL COMMENT '最后一次失败原因' AFTER retry_count;

-- 更新 status 注释
ALTER TABLE fact_profit_pool MODIFY COLUMN status INT NOT NULL DEFAULT 1 COMMENT '1待结算 2已结算 3分发失败待重试';
```
