# ============================================================
# IronBull 生产 Nginx 配置
# 用法：
#   1. 修改 server_name 为实际域名
#   2. 修改 root 路径为 admin-web/dist 的实际部署路径
#   3. 按需启用 HTTPS（建议生产必须开启）
#   4. ln -s /path/to/deploy/nginx.conf /etc/nginx/sites-enabled/ironbull.conf
#   5. nginx -t && nginx -s reload
# ============================================================

# --- admin-web 管理后台 (port 80/443) ---
server {
    listen 80;
    server_name admin.ironbull.example.com;  # 改为实际域名

    # ---- 如需 HTTPS（推荐）取消下方注释 ----
    # listen 443 ssl http2;
    # ssl_certificate     /etc/letsencrypt/live/admin.ironbull.example.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/admin.ironbull.example.com/privkey.pem;
    # ssl_protocols       TLSv1.2 TLSv1.3;
    # ssl_ciphers         HIGH:!aNULL:!MD5;
    # if ($scheme = http) { return 301 https://$host$request_uri; }

    # 前端静态资源（admin-web build 产物）
    root /opt/ironbull/services/admin-web/dist;  # 改为实际路径
    index index.html;

    # SPA history 模式：所有非文件请求回退到 index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源长缓存（Vite 产物带 hash）
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 反向代理 → data-api (8026)
    location /api/ {
        proxy_pass http://127.0.0.1:8026;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
    }

    # health check 透传
    location = /health {
        proxy_pass http://127.0.0.1:8026;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }

    access_log /var/log/nginx/ironbull-admin.access.log;
    error_log  /var/log/nginx/ironbull-admin.error.log;
}


# --- merchant-api 代理商接口 (独立端口 or 独立域名) ---
server {
    listen 80;
    server_name api.ironbull.example.com;  # 改为实际域名

    # ---- HTTPS（推荐）----
    # listen 443 ssl http2;
    # ssl_certificate     /etc/letsencrypt/live/api.ironbull.example.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/api.ironbull.example.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:8010;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }

    access_log /var/log/nginx/ironbull-merchant.access.log;
    error_log  /var/log/nginx/ironbull-merchant.error.log;
}
